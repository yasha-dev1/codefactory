name: Weekly Harness Metrics

on:
  schedule:
    - cron: '0 10 * * 5' # Every Friday at 10:00 UTC
  workflow_dispatch: {}

permissions:
  issues: read
  contents: read

jobs:
  metrics:
    name: Harness Gap Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Collect harness gap metrics
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'harness-gap',
              state: 'all',
              per_page: 100,
            });

            const open = issues.filter(i => i.state === 'open');
            const closed = issues.filter(i => i.state === 'closed');

            const hasPriority = (issue, p) =>
              issue.labels.some(l => l.name === p);

            const p0Open = open.filter(i => hasPriority(i, 'P0'));
            const p1Open = open.filter(i => hasPriority(i, 'P1'));
            const p2Open = open.filter(i => hasPriority(i, 'P2'));
            const p3Open = open.filter(i => hasPriority(i, 'P3'));

            // Mean time to harness (days) for closed issues
            let mtthDays = 0;
            if (closed.length > 0) {
              const totalDays = closed.reduce((sum, i) => {
                const created = new Date(i.created_at);
                const closedAt = new Date(i.closed_at);
                return sum + (closedAt - created) / (1000 * 60 * 60 * 24);
              }, 0);
              mtthDays = totalDays / closed.length;
            }

            // Monthly close rate (closed in last 30 days / total that were open 30 days ago)
            const now = new Date();
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
            const closedRecently = closed.filter(
              i => new Date(i.closed_at) >= thirtyDaysAgo
            );
            const openThirtyDaysAgo = issues.filter(
              i => new Date(i.created_at) <= thirtyDaysAgo &&
                   (i.state === 'open' || new Date(i.closed_at) >= thirtyDaysAgo)
            );
            const closeRate = openThirtyDaysAgo.length > 0
              ? ((closedRecently.length / openThirtyDaysAgo.length) * 100).toFixed(0)
              : '-';

            // SLO compliance: flag overdue gaps
            const sloLimits = { P0: 1, P1: 7, P2: 14, P3: 90 };
            const overdue = open.filter(i => {
              for (const [label, days] of Object.entries(sloLimits)) {
                if (hasPriority(i, label)) {
                  const age = (now - new Date(i.created_at)) / (1000 * 60 * 60 * 24);
                  return age > days;
                }
              }
              return false;
            });

            // Build summary
            const lines = [
              '## Weekly Harness Metrics Report',
              '',
              `_Generated: ${now.toISOString().slice(0, 10)}_`,
              '',
              '### Summary',
              '',
              '| Metric | Target | Current | Status |',
              '|--------|--------|---------|--------|',
              `| MTTH (days) | < 7 | ${mtthDays.toFixed(1)} | ${mtthDays <= 7 || closed.length === 0 ? ':white_check_mark:' : ':x:'} |`,
              `| Open P0 gaps | 0 | ${p0Open.length} | ${p0Open.length === 0 ? ':white_check_mark:' : ':x:'} |`,
              `| Open P1 gaps | < 3 | ${p1Open.length} | ${p1Open.length < 3 ? ':white_check_mark:' : ':x:'} |`,
              `| Close rate (30d) | > 80% | ${closeRate}% | ${closeRate === '-' || parseInt(closeRate) > 80 ? ':white_check_mark:' : ':x:'} |`,
              `| Overdue gaps | 0 | ${overdue.length} | ${overdue.length === 0 ? ':white_check_mark:' : ':x:'} |`,
              '',
              '### Breakdown',
              '',
              '| Priority | Open | Closed | Total |',
              '|----------|------|--------|-------|',
              `| P0 | ${p0Open.length} | ${closed.filter(i => hasPriority(i, 'P0')).length} | ${issues.filter(i => hasPriority(i, 'P0')).length} |`,
              `| P1 | ${p1Open.length} | ${closed.filter(i => hasPriority(i, 'P1')).length} | ${issues.filter(i => hasPriority(i, 'P1')).length} |`,
              `| P2 | ${p2Open.length} | ${closed.filter(i => hasPriority(i, 'P2')).length} | ${issues.filter(i => hasPriority(i, 'P2')).length} |`,
              `| P3 | ${p3Open.length} | ${closed.filter(i => hasPriority(i, 'P3')).length} | ${issues.filter(i => hasPriority(i, 'P3')).length} |`,
              `| **Total** | **${open.length}** | **${closed.length}** | **${issues.length}** |`,
            ];

            if (overdue.length > 0) {
              lines.push('', '### :warning: Overdue Gaps', '');
              lines.push('| # | Title | Priority | Age (days) | SLO |');
              lines.push('|---|-------|----------|------------|-----|');
              for (const i of overdue) {
                const age = ((now - new Date(i.created_at)) / (1000 * 60 * 60 * 24)).toFixed(0);
                const prio = ['P0', 'P1', 'P2', 'P3'].find(p => hasPriority(i, p)) || '?';
                const slo = sloLimits[prio] || '?';
                lines.push(`| #${i.number} | ${i.title} | ${prio} | ${age} | ${slo}d |`);
              }
            }

            const summary = lines.join('\n');
            await core.summary.addRaw(summary).write();
            console.log(summary);
