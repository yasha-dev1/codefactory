name: Documentation Gardening

on:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 9am UTC
  workflow_dispatch: {} # Manual trigger

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: doc-gardening
  cancel-in-progress: true

jobs:
  gardening:
    name: Documentation Gardening
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Check API key
        id: preflight
        run: |
          if [[ -z "${ANTHROPIC_API_KEY}" ]]; then
            echo "::notice::ANTHROPIC_API_KEY is not set — skipping documentation gardening."
            echo "has-key=false" >> "$GITHUB_OUTPUT"
          else
            echo "has-key=true" >> "$GITHUB_OUTPUT"
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Run documentation gardening agent
        if: steps.preflight.outputs.has-key == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_ENTRYPOINT: ci-doc-gardening
        run: |
          set +e
          cat scripts/doc-gardening-prompt.md | claude --max-turns 10 -p - 2>&1
          EXIT_CODE=$?
          set -e

          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "::warning::Claude exited with code ${EXIT_CODE}"
          fi

      - name: Revert non-documentation changes
        if: steps.preflight.outputs.has-key == 'true'
        id: safety
        run: |
          MODIFIED=$(git diff --name-only 2>/dev/null || echo "")
          if [[ -z "$MODIFIED" ]]; then
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
            echo "::notice::Documentation is up-to-date. No changes needed."
            exit 0
          fi

          # Safety net: revert any non-documentation files the agent may have touched
          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            case "$file" in
              *.md|*.mdx|*.rst) ;;
              *)
                echo "::warning::Reverted non-documentation file: ${file}"
                git checkout -- "$file"
                ;;
            esac
          done <<< "$MODIFIED"

          REMAINING=$(git diff --name-only 2>/dev/null || echo "")
          if [[ -z "$REMAINING" ]]; then
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No documentation changes remain after safety revert."
          else
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            COUNT=$(echo "$REMAINING" | wc -l | tr -d ' ')
            echo "✔ ${COUNT} documentation file(s) modified"
            echo "$REMAINING"
          fi

      - name: Create or update pull request
        if: steps.safety.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          title: 'docs: weekly documentation gardening'
          body: |
            ## Automated Documentation Gardening

            This PR was generated by the weekly doc-gardening workflow.

            ### Changes include:
            - Updated stale references to renamed/deleted source files or functions
            - Fixed broken internal markdown links
            - Synchronized documented commands with actual `package.json` scripts
            - Removed references to deprecated APIs or deleted modules
            - Updated `CLAUDE.md` / `docs/` if project tooling or structure has changed

            ### Files scanned:
            - `README.md`, `CLAUDE.md`
            - `docs/architecture.md`, `docs/conventions.md`, `docs/layers.md`

            **Risk tier**: Tier 1 (documentation only)

            Please review changes carefully before merging.
          branch: docs/weekly-gardening
          commit-message: 'docs: automated documentation gardening'
          committer: 'doc-gardening-bot[bot] <doc-gardening-bot[bot]@users.noreply.github.com>'
          author: 'doc-gardening-bot[bot] <doc-gardening-bot[bot]@users.noreply.github.com>'
          labels: |
            documentation
            automated
          delete-branch: true
