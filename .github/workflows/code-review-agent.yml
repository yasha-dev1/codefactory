name: Code Review Agent

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  checks: write
  issues: write
  id-token: write

concurrency:
  group: review-agent-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    name: Review Agent
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout at PR head SHA
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Determine risk tier
        id: tier
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Verify SHA discipline
          ACTUAL_SHA="$(git rev-parse HEAD)"
          if [[ "${ACTUAL_SHA,,}" != "${HEAD_SHA,,}" ]]; then
            echo "::error::SHA discipline violation: HEAD (${ACTUAL_SHA}) ‚â† expected (${HEAD_SHA})"
            exit 1
          fi

          # Ensure base ref is available
          if ! git rev-parse --verify "origin/${BASE_REF}" &>/dev/null; then
            git fetch origin "${BASE_REF}" --depth=1 2>/dev/null || true
          fi

          MERGE_BASE="$(git merge-base "origin/${BASE_REF}" HEAD 2>/dev/null || echo "")"
          if [[ -z "$MERGE_BASE" ]]; then
            echo "tier=3" >> "$GITHUB_OUTPUT"
            echo "changed-files=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CHANGED="$(git diff --name-only "${MERGE_BASE}...HEAD" 2>/dev/null || echo "")"
          if [[ -z "$CHANGED" ]]; then
            echo "tier=1" >> "$GITHUB_OUTPUT"
            echo "changed-files=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TIER=1
          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            case "$file" in
              src/index.ts|src/cli.ts|package.json|tsconfig.json|tsup.config.ts|vitest.config.ts|eslint.config.js)
                TIER=3 ;;
              src/commands/*.ts|src/core/*.ts|src/harnesses/index.ts|src/harnesses/types.ts)
                [[ $TIER -lt 3 ]] && TIER=3 ;;
              src/*.ts|tests/*.ts|scripts/*.ts|*.ts|*.js|*.mjs)
                [[ $TIER -lt 2 ]] && TIER=2 ;;
            esac
          done <<< "$CHANGED"

          echo "tier=${TIER}" >> "$GITHUB_OUTPUT"

          # Serialize changed files for the review prompt
          {
            echo "changed-files<<CEOF"
            echo "$CHANGED"
            echo "CEOF"
          } >> "$GITHUB_OUTPUT"

          echo "‚úî Tier ${TIER} ‚Äî $(echo "$CHANGED" | wc -l) files changed"

      - name: Skip if Tier 1
        if: steps.tier.outputs.tier == '1'
        run: echo "Tier 1 change ‚Äî review agent not required. Skipping."

      - name: SHA deduplication check
        if: steps.tier.outputs.tier != '1'
        id: dedup
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const headSha = context.payload.pull_request.head.sha;
            const marker = `<!-- harness-review: ${headSha} -->`;
            const prNumber = context.payload.pull_request.number;

            core.info(`Checking for existing review of SHA ${headSha.slice(0, 12)}...`);

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const alreadyReviewed = comments.some((c) => c.body?.includes(marker));
            if (alreadyReviewed) {
              core.info(`SHA ${headSha.slice(0, 12)} already reviewed ‚Äî skipping.`);
              core.setOutput('skip', 'true');
            } else {
              core.info(`No existing review for SHA ${headSha.slice(0, 12)} ‚Äî proceeding.`);
              core.setOutput('skip', 'false');
            }

      - name: Create in-progress check run
        if: steps.tier.outputs.tier != '1' && steps.dedup.outputs.skip != 'true'
        id: check
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const headSha = context.payload.pull_request.head.sha;
            const { data: checkRun } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'review-agent',
              head_sha: headSha,
              status: 'in_progress',
              started_at: new Date().toISOString(),
              output: {
                title: 'Code Review Agent',
                summary: 'Review in progress...',
              },
            });
            core.setOutput('check-run-id', checkRun.id);
            core.info(`Created check run ${checkRun.id} for SHA ${headSha.slice(0, 12)}`);

      - name: Run Claude review
        if: steps.tier.outputs.tier != '1' && steps.dedup.outputs.skip != 'true'
        id: review
        # OIDC validation requires the workflow file to match main exactly.
        # PRs that modify this workflow file will always fail the OIDC exchange ‚Äî
        # that is expected and correct (prevents permission escalation). We use
        # continue-on-error so the job still completes and the check run is marked
        # neutral rather than hard-failing the PR.
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review this pull request for bugs, security issues, and architectural violations.
            This is a Tier ${{ steps.tier.outputs.tier }} change.
            Changed files: ${{ steps.tier.outputs.changed-files }}
            Focus on: code correctness, security vulnerabilities, architectural boundary violations, and test coverage.
            Read the CLAUDE.md and harness.config.json for project conventions and architectural boundaries.
          claude_args: '--max-turns 100 --allowedTools "Read,Glob,Grep,Bash"'
          allowed_bots: 'github-actions,implementer-bot'

      - name: Post review marker
        if: steps.tier.outputs.tier != '1' && steps.dedup.outputs.skip != 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          REVIEW_RESULT: ${{ steps.review.outputs.result || '' }}
          REVIEW_OUTCOME: ${{ steps.review.outcome }}
        with:
          script: |
            const headSha = context.payload.pull_request.head.sha;
            const marker = `<!-- harness-review: ${headSha} -->`;
            const tier = '${{ steps.tier.outputs.tier }}';
            const reviewResult = process.env.REVIEW_RESULT || '';
            const reviewOutcome = process.env.REVIEW_OUTCOME || 'failure';

            const sections = [
              marker,
              `## üîç Code Review Agent ‚Äî Tier ${tier}`,
              '',
              `**Commit**: \`${headSha.slice(0, 12)}\``,
              `**Status**: ${reviewOutcome === 'success' ? '‚úÖ Complete' : '‚ö†Ô∏è Review may be incomplete'}`,
            ];

            if (reviewResult) {
              sections.push('', '### Review', '', reviewResult);
            } else {
              sections.push('', '*No review output was produced. The review agent may have encountered an error.*');
            }

            sections.push(
              '',
              '---',
              '*ü§ñ [Code Review Agent](https://github.com/codefactory) ‚Äî automated code review.*',
            );

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: sections.join('\n'),
            });

      - name: Complete check run
        if: always() && steps.check.outputs.check-run-id
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          CHECK_RUN_ID: ${{ steps.check.outputs.check-run-id }}
          REVIEW_OUTCOME: ${{ steps.review.outcome }}
        with:
          script: |
            const checkRunId = parseInt(process.env.CHECK_RUN_ID);
            const reviewOutcome = process.env.REVIEW_OUTCOME || 'failure';
            const conclusion = reviewOutcome === 'success' ? 'success' : 'neutral';

            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: checkRunId,
              status: 'completed',
              conclusion,
              completed_at: new Date().toISOString(),
              output: {
                title: `Review Agent ‚Äî ${conclusion === 'success' ? 'Complete' : 'Review Needed'}`,
                summary: `Claude Code review completed with outcome: ${reviewOutcome}`,
              },
            });

            core.info(`Check run ${checkRunId} completed: ${conclusion}`);

      - name: Report skip as success
        if: steps.tier.outputs.tier == '1' || steps.dedup.outputs.skip == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const headSha = context.payload.pull_request.head.sha;
            const tier = '${{ steps.tier.outputs.tier }}';
            const skipped = '${{ steps.dedup.outputs.skip }}' === 'true';
            const reason = tier === '1' ? 'Tier 1 ‚Äî review not required' : `SHA ${headSha.slice(0, 12)} already reviewed`;

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'review-agent',
              head_sha: headSha,
              status: 'completed',
              conclusion: 'success',
              completed_at: new Date().toISOString(),
              output: {
                title: `Review Agent ‚Äî Skipped`,
                summary: reason,
              },
            });

            core.info(`Review skipped: ${reason}`);
