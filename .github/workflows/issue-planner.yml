name: Issue Planner Agent

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to plan'
        required: true
        type: string

permissions:
  issues: write
  contents: read
  actions: write
  id-token: write

concurrency:
  group: issue-planner-${{ github.event.issue.number || inputs.issue_number }}
  cancel-in-progress: true

jobs:
  plan:
    name: Planner Agent
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Fetch issue JSON (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: fetch-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ inputs.issue_number }}"
          # gh CLI uses 'author' not 'user' ‚Äî remap to match github.event.issue shape
          ISSUE_DATA=$(gh issue view "$ISSUE_NUM" --json number,title,body,labels,author \
            | jq '{number, title, body, labels, user: {login: .author.login, type: (if .author.is_bot then "Bot" else "User" end)}}')
          {
            echo "json<<ISSUE_EOF"
            echo "$ISSUE_DATA"
            echo "ISSUE_EOF"
          } >> "$GITHUB_OUTPUT"
          echo "Fetched issue #${ISSUE_NUM}"

      - name: Run planner guard
        id: guard
        env:
          ISSUE_JSON: ${{ github.event_name == 'workflow_dispatch' && steps.fetch-issue.outputs.json || toJSON(github.event.issue) }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DECISION=$(npx tsx scripts/issue-planner-guard.ts --evaluate)
          echo "decision<<GUARD_EOF" >> "$GITHUB_OUTPUT"
          echo "$DECISION" >> "$GITHUB_OUTPUT"
          echo "GUARD_EOF" >> "$GITHUB_OUTPUT"

          SHOULD=$(echo "$DECISION" | jq -r '.shouldPlan')
          REASON=$(echo "$DECISION" | jq -r '.reason')
          ISSUE_NUM=$(echo "$DECISION" | jq -r '.issueNumber')
          ISSUE_TITLE=$(echo "$DECISION" | jq -r '.issueTitle')
          echo "should-plan=${SHOULD}" >> "$GITHUB_OUTPUT"
          echo "reason=${REASON}" >> "$GITHUB_OUTPUT"
          echo "issue-number=${ISSUE_NUM}" >> "$GITHUB_OUTPUT"
          echo "issue-title=${ISSUE_TITLE}" >> "$GITHUB_OUTPUT"

          echo "Guard: shouldPlan=${SHOULD}, issue=#${ISSUE_NUM}"

      - name: Skip ‚Äî log reason
        if: steps.guard.outputs.should-plan == 'false'
        run: |
          echo "::notice::Planning skipped: ${{ steps.guard.outputs.reason }}"

      - name: Ensure planner labels exist
        if: steps.guard.outputs.should-plan == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const labels = [
              { name: 'agent:plan', color: '1D76DB', description: 'Approved for automated planning' },
              { name: 'agent:implement', color: '0E8A16', description: 'Approved for automated implementation' },
              { name: 'agent:needs-judgment', color: 'E4E669', description: 'Agent needs human judgment to proceed' },
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ...label,
                });
                core.info(`Created label: ${label.name}`);
              } catch {
                // Label already exists ‚Äî fine
              }
            }

      - name: Read planner prompt
        if: steps.guard.outputs.should-plan == 'true'
        id: prompt-file
        run: |
          if [[ -f ".codefactory/prompts/issue-planner.md" ]]; then
            {
              echo "content<<PROMPT_EOF"
              cat .codefactory/prompts/issue-planner.md
              echo "PROMPT_EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "content=Analyze this issue and produce a structured implementation plan." >> "$GITHUB_OUTPUT"
          fi

      - name: Build planning prompt
        if: steps.guard.outputs.should-plan == 'true'
        id: build-prompt
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PLANNER_TEMPLATE: ${{ steps.prompt-file.outputs.content }}
          ISSUE_JSON: ${{ github.event_name == 'workflow_dispatch' && steps.fetch-issue.outputs.json || toJSON(github.event.issue) }}
        with:
          script: |
            const fs = require('fs');
            const issue = JSON.parse(process.env.ISSUE_JSON || '{}');
            const template = process.env.PLANNER_TEMPLATE || '';

            let conventions = '';
            try { conventions = fs.readFileSync('CLAUDE.md', 'utf-8').slice(0, 6000); } catch {}

            let config = '';
            try { config = fs.readFileSync('harness.config.json', 'utf-8'); } catch {}

            const prompt = [
              template,
              '',
              '## Issue to Plan',
              '',
              `**Number**: #${issue.number}`,
              `**Title**: ${issue.title}`,
              `**Author**: ${(issue.user || {}).login || 'unknown'}`,
              '',
              '### Body',
              '',
              issue.body || '*(empty body)*',
              '',
              '## Project Conventions (from CLAUDE.md)',
              '',
              conventions || 'No CLAUDE.md found.',
              '',
              '## Harness Configuration',
              '',
              '```json',
              config || '{}',
              '```',
            ].join('\n');

            core.setOutput('prompt', prompt);
            core.info(`Planning prompt built (${prompt.length} chars)`);

      - name: Run Claude planning analysis
        if: steps.guard.outputs.should-plan == 'true'
        id: claude-plan
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.build-prompt.outputs.prompt }}
          claude_args: '--model claude-opus-4-6 --max-turns 30 --allowedTools "Read,Glob,Grep,Bash"'
          allowed_bots: 'github-actions'

      - name: Extract plan from execution file
        if: steps.guard.outputs.should-plan == 'true'
        id: extract-plan
        env:
          EXECUTION_FILE: ${{ steps.claude-plan.outputs.execution_file }}
        run: |
          if [[ -z "$EXECUTION_FILE" || ! -f "$EXECUTION_FILE" ]]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "::warning::No execution file available"
            exit 0
          fi

          echo "Execution file: ${EXECUTION_FILE} ($(wc -c < "$EXECUTION_FILE") bytes)"

          # The execution file is JSONL from Claude Code SDK.
          # Slurp into array, find assistant messages, extract last text content.
          PLAN_TEXT=$(jq -s -r '
            [.[] | select(.type == "assistant") |
             (.message.content // [])[] | select(.type == "text") | .text
            ] | last // ""
          ' "$EXECUTION_FILE" 2>/dev/null || echo "")

          if [[ -z "$PLAN_TEXT" || "$PLAN_TEXT" == "null" ]]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Could not extract plan text from execution file"
          else
            PLAN_TEXT="${PLAN_TEXT:0:60000}"
            {
              echo "plan<<PLAN_EOF"
              echo "$PLAN_TEXT"
              echo "PLAN_EOF"
            } >> "$GITHUB_OUTPUT"
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "‚úî Extracted plan ($(echo "$PLAN_TEXT" | wc -c) chars)"
          fi

      - name: Post plan comment and dispatch implementer
        if: steps.guard.outputs.should-plan == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PLAN_TEXT: ${{ steps.extract-plan.outputs.plan || '' }}
          PLAN_FOUND: ${{ steps.extract-plan.outputs.found || 'false' }}
        with:
          script: |
            const issueNumber = parseInt('${{ steps.guard.outputs.issue-number }}', 10);
            const planFound = process.env.PLAN_FOUND === 'true';
            const planOutput = (planFound && process.env.PLAN_TEXT) ? process.env.PLAN_TEXT : '*No plan output received.*';

            // Post plan comment with marker
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `<!-- issue-planner: #${issueNumber} -->`,
                '## üìã Implementation Plan',
                '',
                planOutput,
                '',
                '---',
                '*ü§ñ [Issue Planner Agent](https://github.com/codefactory) ‚Äî automated implementation planning.*',
              ].join('\n'),
            });

            // Add agent:implement label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['agent:implement'],
            });

            core.info(`Plan posted and agent:implement label added for issue #${issueNumber}`);

      - name: Dispatch implementer workflow
        if: steps.guard.outputs.should-plan == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.guard.outputs.issue-number }}"
          echo "Dispatching implementer for issue #${ISSUE_NUM}..."
          gh workflow run issue-implementer.yml \
            --field issue_number="${ISSUE_NUM}"
          echo "‚úî Implementer workflow dispatched."

      - name: Failure handler
        if: failure() && steps.guard.outputs.should-plan == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issueNumber = parseInt('${{ steps.guard.outputs.issue-number }}', 10);

            // Add judgment label
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'agent:needs-judgment',
                color: 'E4E669',
                description: 'Agent needs human judgment to proceed',
              });
            } catch {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['agent:needs-judgment'],
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `<!-- issue-planner-failed: #${issueNumber} -->`,
                '## ‚ùå Planner Agent ‚Äî Failed',
                '',
                'The planning agent encountered an error while analyzing this issue.',
                'A human should review the failure and decide next steps.',
                '',
                `**Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                '',
                '---',
                '*ü§ñ [Issue Planner Agent](https://github.com/codefactory) ‚Äî automated implementation planning.*',
              ].join('\n'),
            });
