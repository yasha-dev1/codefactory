name: Remediation Agent

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to remediate
        required: true
        type: number
      head_sha:
        description: Commit SHA to fix against (SHA discipline)
        required: true
        type: string
      findings:
        description: JSON array of actionable review findings
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: remediation-${{ inputs.pr_number }}
  cancel-in-progress: false

jobs:
  remediate:
    name: Remediation Agent
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Get PR branch info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_JSON=$(gh pr view ${{ inputs.pr_number }} --repo "${{ github.repository }}" --json headRefName,headRefOid,state)
          BRANCH=$(echo "$PR_JSON" | jq -r '.headRefName')
          CURRENT_SHA=$(echo "$PR_JSON" | jq -r '.headRefOid')
          STATE=$(echo "$PR_JSON" | jq -r '.state')

          if [[ "$STATE" != "OPEN" ]]; then
            echo "::error::PR #${{ inputs.pr_number }} is ${STATE}, not OPEN. Aborting."
            exit 1
          fi

          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "current-sha=${CURRENT_SHA}" >> "$GITHUB_OUTPUT"

      - name: SHA discipline check
        run: |
          CURRENT="${{ steps.pr-info.outputs.current-sha }}"
          EXPECTED="${{ inputs.head_sha }}"
          if [[ "${CURRENT,,}" != "${EXPECTED,,}" ]]; then
            echo "::error::SHA discipline violation: PR HEAD (${CURRENT}) ‚â† expected (${EXPECTED}). Branch was updated since dispatch."
            exit 1
          fi
          echo "‚úî SHA verified: ${CURRENT:0:12}"

      - name: Checkout PR branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ steps.pr-info.outputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify checkout SHA
        run: |
          ACTUAL="$(git rev-parse HEAD)"
          EXPECTED="${{ inputs.head_sha }}"
          if [[ "${ACTUAL,,}" != "${EXPECTED,,}" ]]; then
            echo "::error::Post-checkout SHA mismatch: ${ACTUAL} ‚â† ${EXPECTED}"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run remediation guard
        id: guard
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ inputs.pr_number }}
          FINDINGS: ${{ inputs.findings }}
          STRICTNESS: relaxed
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          DECISION=$(npx tsx scripts/remediation-guard.ts --evaluate)
          echo "decision<<GUARD_EOF" >> "$GITHUB_OUTPUT"
          echo "$DECISION" >> "$GITHUB_OUTPUT"
          echo "GUARD_EOF" >> "$GITHUB_OUTPUT"

          SHOULD=$(echo "$DECISION" | jq -r '.shouldRemediate')
          ATTEMPT=$(echo "$DECISION" | jq -r '.attemptNumber')
          REASON=$(echo "$DECISION" | jq -r '.reason')
          echo "should-remediate=${SHOULD}" >> "$GITHUB_OUTPUT"
          echo "attempt=${ATTEMPT}" >> "$GITHUB_OUTPUT"
          echo "reason=${REASON}" >> "$GITHUB_OUTPUT"

          echo "Guard: shouldRemediate=${SHOULD}, attempt=${ATTEMPT}"

      - name: Post guard rejection comment
        if: steps.guard.outputs.should-remediate == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          DECISION: ${{ steps.guard.outputs.decision }}
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};
            const headSha = '${{ inputs.head_sha }}';
            const decision = JSON.parse(process.env.DECISION);
            const marker = `<!-- remediation-blocked: ${headSha} -->`;

            const sections = [
              marker,
              '## üõë Remediation Agent ‚Äî Blocked',
              '',
              `**Reason**: ${decision.reason}`,
              `**Attempt**: ${decision.attemptNumber}`,
              `**SHA**: \`${headSha.slice(0, 12)}\``,
            ];

            if (decision.securityBlockers.length > 0) {
              sections.push('', '### Security Findings (require human review)');
              for (const s of decision.securityBlockers) sections.push(`- ${s}`);
            }

            if (decision.skippedFindings.length > 0) {
              sections.push('', '### Skipped Findings');
              for (const s of decision.skippedFindings) sections.push(`- ${s}`);
            }

            sections.push(
              '',
              '---',
              '*ü§ñ [Remediation agent](https://github.com/codefactory) ‚Äî auto-fix blocked.*',
            );

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: sections.join('\n'),
            });

      - name: Build remediation prompt
        if: steps.guard.outputs.should-remediate == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          FINDINGS_JSON: ${{ inputs.findings }}
          HEAD_SHA: ${{ inputs.head_sha }}
        with:
          script: |
            const fs = require('fs');

            let template = '';
            try { template = fs.readFileSync('scripts/remediation-agent-prompt.md', 'utf-8'); } catch {}

            let conventions = '';
            try { conventions = fs.readFileSync('CLAUDE.md', 'utf-8').slice(0, 6000); } catch {}

            let config = '';
            try { config = fs.readFileSync('harness.config.json', 'utf-8'); } catch {}

            const findings = process.env.FINDINGS_JSON;
            const sha = process.env.HEAD_SHA;

            const prompt = [
              template,
              '',
              '## Project Conventions (from CLAUDE.md)',
              '',
              conventions || 'No CLAUDE.md found.',
              '',
              '## Harness Configuration',
              '',
              '```json',
              config || '{}',
              '```',
              '',
              '## Findings to Fix',
              '',
              '```json',
              findings,
              '```',
              '',
              `## HEAD SHA: \`${sha}\``,
              '',
              'Fix ONLY the findings listed above. Edit each file directly.',
              'After all fixes, output a JSON object:',
              '```json',
              '{',
              '  "fixed": [{ "file": "path", "finding": "description", "change": "what changed" }],',
              '  "skipped": [{ "file": "path", "finding": "description", "reason": "why" }],',
              '  "filesModified": ["path1", "path2"]',
              '}',
              '```',
            ].join('\n');

            fs.writeFileSync('/tmp/remediation-prompt.txt', prompt);
            core.info(`Prompt written (${prompt.length} chars)`);

      - name: Run Claude remediation
        if: steps.guard.outputs.should-remediate == 'true'
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_ENTRYPOINT: ci-remediation
        run: |
          if [[ -z "${ANTHROPIC_API_KEY}" ]]; then
            echo "::error::ANTHROPIC_API_KEY secret is not set."
            exit 1
          fi

          set +e
          OUTPUT=$(cat /tmp/remediation-prompt.txt | claude --max-turns 15 --output-format json -p - 2>&1)
          EXIT_CODE=$?
          set -e

          echo "$OUTPUT" > /tmp/remediation-output.txt

          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "::warning::Claude exited with code ${EXIT_CODE}"
            echo "claude-ok=false" >> "$GITHUB_OUTPUT"
          else
            echo "claude-ok=true" >> "$GITHUB_OUTPUT"
          fi

          # Extract the JSON summary from output
          SUMMARY=$(echo "$OUTPUT" | node -e "
            const input = require('fs').readFileSync(0, 'utf-8');
            const match = input.match(/\{[\s\S]*\"fixed\"[\s\S]*\}/);
            if (match) {
              try { JSON.parse(match[0]); console.log(match[0]); }
              catch { console.log('{}'); }
            } else { console.log('{}'); }
          " 2>/dev/null || echo '{}')

          echo "summary<<SUMMARY_EOF" >> "$GITHUB_OUTPUT"
          echo "$SUMMARY" >> "$GITHUB_OUTPUT"
          echo "SUMMARY_EOF" >> "$GITHUB_OUTPUT"

      - name: Check for file changes
        if: steps.guard.outputs.should-remediate == 'true'
        id: changes
        run: |
          CHANGED=$(git diff --name-only 2>/dev/null || echo "")
          if [[ -z "$CHANGED" ]]; then
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No files were modified by the remediation agent."
          else
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            COUNT=$(echo "$CHANGED" | wc -l)
            echo "count=${COUNT}" >> "$GITHUB_OUTPUT"
            {
              echo "files<<FILES_EOF"
              echo "$CHANGED"
              echo "FILES_EOF"
            } >> "$GITHUB_OUTPUT"
            echo "‚úî ${COUNT} file(s) modified"
          fi

      - name: Verify no protected files modified
        if: steps.changes.outputs.has-changes == 'true'
        id: protected
        run: |
          MODIFIED=$(git diff --name-only)
          VIOLATIONS=""

          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            case "$file" in
              .github/workflows/*|harness.config.json|CLAUDE.md|package-lock.json|yarn.lock|pnpm-lock.yaml)
                VIOLATIONS="${VIOLATIONS}  - ${file}\n"
                git checkout -- "$file"
                echo "::warning::Reverted protected file: ${file}"
                ;;
            esac
          done <<< "$MODIFIED"

          if [[ -n "$VIOLATIONS" ]]; then
            echo "reverted=true" >> "$GITHUB_OUTPUT"
            echo "::warning::Reverted modifications to protected files."
          else
            echo "reverted=false" >> "$GITHUB_OUTPUT"
          fi

          # Re-check if we still have changes after reverting
          REMAINING=$(git diff --name-only 2>/dev/null || echo "")
          if [[ -z "$REMAINING" ]]; then
            echo "::notice::No changes remain after reverting protected files."
            echo "has-remaining=false" >> "$GITHUB_OUTPUT"
          else
            echo "has-remaining=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Run validation ‚Äî Lint
        if: steps.changes.outputs.has-changes == 'true' && steps.protected.outputs.has-remaining == 'true'
        id: lint
        run: |
          # Try eslint auto-fix first for minor formatting issues
          npx eslint src/ --fix 2>/dev/null || true

          if npm run lint; then
            echo "passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "passed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run validation ‚Äî Type Check
        if: steps.changes.outputs.has-changes == 'true' && steps.protected.outputs.has-remaining == 'true'
        id: typecheck
        run: |
          if npm run typecheck; then
            echo "passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "passed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run validation ‚Äî Tests
        if: steps.changes.outputs.has-changes == 'true' && steps.protected.outputs.has-remaining == 'true'
        id: test
        run: |
          if npm test; then
            echo "passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "passed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Evaluate validation results
        if: steps.changes.outputs.has-changes == 'true' && steps.protected.outputs.has-remaining == 'true'
        id: validation
        run: |
          LINT="${{ steps.lint.outputs.passed }}"
          TYPECHECK="${{ steps.typecheck.outputs.passed }}"
          TEST="${{ steps.test.outputs.passed }}"

          echo "lint=${LINT}, typecheck=${TYPECHECK}, test=${TEST}"

          if [[ "$LINT" == "true" && "$TYPECHECK" == "true" && "$TEST" == "true" ]]; then
            echo "passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "passed=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Validation failed ‚Äî reverting all remediation changes."
            git checkout -- .
          fi

      - name: Commit and push
        if: steps.validation.outputs.passed == 'true'
        id: commit
        run: |
          git config user.name "remediation-bot[bot]"
          git config user.email "remediation-bot[bot]@users.noreply.github.com"

          ATTEMPT="${{ steps.guard.outputs.attempt }}"
          MODIFIED=$(git diff --name-only)

          git add $MODIFIED

          SUMMARY="${{ steps.claude.outputs.summary }}"
          FIXED_COUNT=$(echo "$SUMMARY" | jq '.fixed | length' 2>/dev/null || echo "0")
          SKIPPED_COUNT=$(echo "$SUMMARY" | jq '.skipped | length' 2>/dev/null || echo "0")

          git commit -m "$(cat <<COMMIT_EOF
          fix: [remediation] auto-fix ${FIXED_COUNT} review finding(s) (attempt ${ATTEMPT})

          Remediation agent auto-fix for PR #${{ inputs.pr_number }}.
          SHA: ${{ inputs.head_sha }}

          Fixed: ${FIXED_COUNT} finding(s)
          Skipped: ${SKIPPED_COUNT} finding(s)
          Files: $(echo "$MODIFIED" | tr '\n' ', ')
          COMMIT_EOF
          )"

          git push
          NEW_SHA=$(git rev-parse HEAD)
          echo "new-sha=${NEW_SHA}" >> "$GITHUB_OUTPUT"
          echo "‚úî Pushed remediation commit: ${NEW_SHA:0:12}"

      - name: Add remediation attempt label
        if: steps.guard.outputs.should-remediate == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          ATTEMPT: ${{ steps.guard.outputs.attempt }}
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};
            const attempt = parseInt(process.env.ATTEMPT);
            const label = `remediation-attempt-${attempt}`;

            // Create label if it doesn't exist
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label,
                color: 'FFA500',
                description: `Remediation agent attempt ${attempt}`,
              });
            } catch {
              // Label already exists ‚Äî that's fine
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [label],
            });

            core.info(`Added label: ${label}`);

      - name: Post audit comment
        if: always() && steps.guard.outputs.should-remediate == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          GUARD_DECISION: ${{ steps.guard.outputs.decision }}
          CLAUDE_SUMMARY: ${{ steps.claude.outputs.summary }}
          HAS_CHANGES: ${{ steps.changes.outputs.has-changes }}
          CHANGED_FILES: ${{ steps.changes.outputs.files }}
          VALIDATION_PASSED: ${{ steps.validation.outputs.passed }}
          LINT_PASSED: ${{ steps.lint.outputs.passed }}
          TYPECHECK_PASSED: ${{ steps.typecheck.outputs.passed }}
          TEST_PASSED: ${{ steps.test.outputs.passed }}
          NEW_SHA: ${{ steps.commit.outputs.new-sha }}
          ATTEMPT: ${{ steps.guard.outputs.attempt }}
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};
            const headSha = '${{ inputs.head_sha }}';
            const attempt = process.env.ATTEMPT;
            const marker = `<!-- remediation-audit: ${headSha} -->`;

            let summary;
            try { summary = JSON.parse(process.env.CLAUDE_SUMMARY || '{}'); } catch { summary = {}; }

            const hasChanges = process.env.HAS_CHANGES === 'true';
            const validationPassed = process.env.VALIDATION_PASSED === 'true';
            const newSha = process.env.NEW_SHA || '';

            const lintOk = process.env.LINT_PASSED === 'true';
            const typecheckOk = process.env.TYPECHECK_PASSED === 'true';
            const testOk = process.env.TEST_PASSED === 'true';

            const statusEmoji = validationPassed && newSha ? '‚úÖ' : hasChanges ? '‚ö†Ô∏è' : 'üí¨';
            const statusText = validationPassed && newSha
              ? 'Fixes Applied'
              : hasChanges
                ? 'Fixes Failed Validation'
                : 'No Changes Made';

            const fixed = summary.fixed || [];
            const skipped = summary.skipped || [];

            let fixedSection = '';
            if (fixed.length > 0) {
              fixedSection = [
                '### Findings Fixed',
                '',
                '| File | Finding | Change |',
                '|------|---------|--------|',
                ...fixed.map((f) => `| \`${f.file}\` | ${f.finding} | ${f.change} |`),
              ].join('\n');
            }

            let skippedSection = '';
            if (skipped.length > 0) {
              skippedSection = [
                '### Findings Skipped',
                '',
                '| File | Finding | Reason |',
                '|------|---------|--------|',
                ...skipped.map((s) => `| \`${s.file}\` | ${s.finding} | ${s.reason} |`),
              ].join('\n');
            }

            const validationSection = hasChanges ? [
              '### Validation',
              '',
              `| Check | Status |`,
              `|-------|--------|`,
              `| Lint | ${lintOk ? '‚úÖ' : '‚ùå'} |`,
              `| Type Check | ${typecheckOk ? '‚úÖ' : '‚ùå'} |`,
              `| Tests | ${testOk ? '‚úÖ' : '‚ùå'} |`,
            ].join('\n') : '';

            const body = [
              marker,
              `## ${statusEmoji} Remediation Agent ‚Äî ${statusText}`,
              '',
              `**Attempt**: ${attempt}`,
              `**Source SHA**: \`${headSha.slice(0, 12)}\``,
              newSha ? `**New SHA**: \`${newSha.slice(0, 12)}\`` : '',
              '',
              fixedSection,
              skippedSection,
              validationSection,
              '',
              '---',
              '*ü§ñ [Remediation agent](https://github.com/codefactory) ‚Äî automated code fix.*',
            ].filter(Boolean).join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
