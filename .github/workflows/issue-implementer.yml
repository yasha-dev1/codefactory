name: Issue Implementer Agent

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to implement'
        required: false
        type: string
      pr_number:
        description: 'PR number for review-fix mode'
        required: false
        type: string
      review_fix_cycle:
        description: 'Review-fix cycle number (1-3)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write

concurrency:
  group: issue-implementer-${{ inputs.pr_number && format('pr-{0}', inputs.pr_number) || github.event.issue.number || inputs.issue_number }}
  cancel-in-progress: false

jobs:
  implement:
    name: Implementer Agent
    if: github.event_name == 'workflow_dispatch' || github.event.label.name == 'agent:implement'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Determine mode
        id: mode
        run: |
          if [[ -n "${{ inputs.pr_number }}" ]]; then
            echo "mode=review-fix" >> "$GITHUB_OUTPUT"
            echo "Mode: review-fix (PR #${{ inputs.pr_number }}, cycle ${{ inputs.review_fix_cycle || '1' }})"
          else
            echo "mode=issue" >> "$GITHUB_OUTPUT"
            echo "Mode: issue implementation"
          fi

      # ======================================================================
      # REVIEW-FIX MODE ‚Äî fix review feedback on an existing PR
      # ======================================================================

      - name: Run review-fix guard
        if: steps.mode.outputs.mode == 'review-fix'
        id: rf-guard
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          REVIEW_FIX_CYCLE: ${{ inputs.review_fix_cycle || '1' }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DECISION=$(npx tsx scripts/issue-implementer-guard.ts --evaluate)
          echo "decision<<GUARD_EOF" >> "$GITHUB_OUTPUT"
          echo "$DECISION" >> "$GITHUB_OUTPUT"
          echo "GUARD_EOF" >> "$GITHUB_OUTPUT"

          SHOULD=$(echo "$DECISION" | jq -r '.shouldFix')
          BRANCH=$(echo "$DECISION" | jq -r '.branchName')
          CYCLE=$(echo "$DECISION" | jq -r '.cycle')
          REASON=$(echo "$DECISION" | jq -r '.reason')
          echo "should-fix=${SHOULD}" >> "$GITHUB_OUTPUT"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "cycle=${CYCLE}" >> "$GITHUB_OUTPUT"
          echo "reason=${REASON}" >> "$GITHUB_OUTPUT"

          echo "Review-fix guard: shouldFix=${SHOULD}, branch=${BRANCH}, cycle=${CYCLE}"

      - name: Skip review-fix ‚Äî log reason
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-guard.outputs.should-fix == 'false'
        run: |
          echo "::notice::Review-fix skipped: ${{ steps.rf-guard.outputs.reason }}"

      - name: Checkout PR branch
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-guard.outputs.should-fix == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.rf-guard.outputs.branch }}"

          # Verify branch exists on remote
          if ! git ls-remote --exit-code origin "refs/heads/${BRANCH}" &>/dev/null; then
            echo "::error::PR branch '${BRANCH}' not found on remote."
            exit 1
          fi

          git config user.name "implementer-bot[bot]"
          git config user.email "implementer-bot[bot]@users.noreply.github.com"

          git fetch origin "${BRANCH}"
          git checkout "${BRANCH}"

          ACTUAL_SHA="$(git rev-parse HEAD)"
          echo "‚úî Checked out branch ${BRANCH} at SHA ${ACTUAL_SHA:0:12}"

      - name: Extract review feedback
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-guard.outputs.should-fix == 'true'
        id: rf-feedback
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            // Find the latest review comment with REQUEST_CHANGES verdict
            const reviewComments = comments
              .filter(c => c.body && c.body.includes('<!-- review-verdict: REQUEST_CHANGES -->'))
              .reverse();

            if (reviewComments.length === 0) {
              core.warning('No REQUEST_CHANGES review comment found ‚Äî proceeding with best judgment.');
              core.setOutput('found', 'false');
              core.setOutput('feedback', 'No specific review feedback found. Review the code and fix any obvious issues.');
              return;
            }

            const latestReview = reviewComments[0];
            let feedback = latestReview.body || '';
            // Truncate to 8000 chars for prompt context
            feedback = feedback.slice(0, 8000);

            core.setOutput('found', 'true');
            core.setOutput('feedback', feedback);
            core.info(`Found review feedback (${feedback.length} chars)`);

      - name: Add review-fix cycle label
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-guard.outputs.should-fix == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          CYCLE: ${{ steps.rf-guard.outputs.cycle }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            const cycle = process.env.CYCLE;
            const label = `review-fix-cycle-${cycle}`;

            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label,
                color: 'C2E0FF',
                description: `Review-fix cycle ${cycle}`,
              });
            } catch {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [label],
            });

            core.info(`Added label: ${label}`);

      - name: Post review-fix starting comment
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-guard.outputs.should-fix == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          CYCLE: ${{ steps.rf-guard.outputs.cycle }}
          BRANCH: ${{ steps.rf-guard.outputs.branch }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            const cycle = process.env.CYCLE;
            const branch = process.env.BRANCH;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                `<!-- review-fix-start: cycle-${cycle} -->`,
                `## üîß Review-Fix Agent ‚Äî Cycle ${cycle}/3`,
                '',
                `Addressing review feedback on branch \`${branch}\`.`,
                '',
                `**Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                '',
                '---',
                '*ü§ñ [Issue Implementer Agent](https://github.com/codefactory) ‚Äî automated review-fix.*',
              ].join('\n'),
            });

      - name: Build review-fix prompt
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-guard.outputs.should-fix == 'true'
        id: rf-prompt
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          REVIEW_FEEDBACK: ${{ steps.rf-feedback.outputs.feedback }}
          CYCLE: ${{ steps.rf-guard.outputs.cycle }}
        with:
          script: |
            const fs = require('fs');
            const feedback = process.env.REVIEW_FEEDBACK || '';
            const cycle = process.env.CYCLE || '1';

            let template = '';
            try { template = fs.readFileSync('.codefactory/prompts/issue-implementer.md', 'utf-8'); } catch {}

            let conventions = '';
            try { conventions = fs.readFileSync('CLAUDE.md', 'utf-8').slice(0, 6000); } catch {}

            let config = '';
            try { config = fs.readFileSync('harness.config.json', 'utf-8'); } catch {}

            const sections = [
              template,
              '',
              '## Mode: Review-Fix',
              '',
              `You are in **review-fix mode** (cycle ${cycle}/3). The review agent requested changes on this PR.`,
              'Your job is to fix ONLY the issues described in the review feedback below.',
              'Do NOT restructure, refactor, or add new features. Make surgical fixes to address the review.',
              '',
              '## Review Feedback to Address',
              '',
              feedback || '*No specific feedback found ‚Äî review the code and fix any obvious issues.*',
              '',
              '## Project Conventions (from CLAUDE.md)',
              '',
              conventions || 'No CLAUDE.md found.',
              '',
              '## Harness Configuration',
              '',
              '```json',
              config || '{}',
              '```',
              '',
              '## Important',
              '',
              '- Fix ONLY the issues flagged in the review. Do not touch unrelated code.',
              '- After making fixes, run quality gates (lint, type-check, test, build) and fix any failures you introduce.',
              '- Do NOT commit ‚Äî the CI workflow handles git operations.',
            ];

            const prompt = sections.join('\n');
            core.setOutput('prompt', prompt);
            core.info(`Review-fix prompt built (${prompt.length} chars)`);

      - name: Run Claude review-fix
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-guard.outputs.should-fix == 'true'
        id: rf-claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.rf-prompt.outputs.prompt }}
          claude_args: '--model claude-opus-4-6 --max-turns 100 --allowedTools "Edit,Write,Read,Glob,Grep,Bash"'
          allowed_bots: 'github-actions'

      - name: Check for review-fix changes
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-guard.outputs.should-fix == 'true'
        id: rf-changes
        run: |
          CHANGED=$(git diff --name-only 2>/dev/null || echo "")
          UNTRACKED=$(git ls-files --others --exclude-standard 2>/dev/null || echo "")
          ALL_FILES=$(echo -e "${CHANGED}\n${UNTRACKED}" | sort -u | grep -v '^$' || echo "")

          if [[ -z "$ALL_FILES" ]]; then
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No files were modified by the review-fix agent."
          else
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            COUNT=$(echo "$ALL_FILES" | wc -l)
            echo "count=${COUNT}" >> "$GITHUB_OUTPUT"
            {
              echo "files<<FILES_EOF"
              echo "$ALL_FILES"
              echo "FILES_EOF"
            } >> "$GITHUB_OUTPUT"
            echo "‚úî ${COUNT} file(s) changed in review-fix"
          fi

      - name: Verify no protected files modified (review-fix)
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-changes.outputs.has-changes == 'true'
        run: |
          MODIFIED=$(git diff --name-only)

          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            case "$file" in
              .github/workflows/*|harness.config.json|CLAUDE.md|package-lock.json|yarn.lock|pnpm-lock.yaml)
                git checkout -- "$file"
                echo "::warning::Reverted protected file: ${file}"
                ;;
            esac
          done <<< "$MODIFIED"

      - name: Run quality gates (review-fix)
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-changes.outputs.has-changes == 'true'
        id: rf-quality
        run: |
          echo "Running quality gates for review-fix..."

          LINT_OK="true"
          TYPECHECK_OK="true"
          TEST_OK="true"
          BUILD_OK="true"

          npm run lint || LINT_OK="false"
          npm run typecheck || TYPECHECK_OK="false"
          npm test || TEST_OK="false"
          npm run build || BUILD_OK="false"

          PASSED="true"
          if [[ "$LINT_OK" == "false" || "$TYPECHECK_OK" == "false" || "$TEST_OK" == "false" || "$BUILD_OK" == "false" ]]; then
            PASSED="false"
            echo "::error::Quality gates failed ‚Äî review-fix changes will not be pushed."
          fi

          echo "lint=${LINT_OK}" >> "$GITHUB_OUTPUT"
          echo "typecheck=${TYPECHECK_OK}" >> "$GITHUB_OUTPUT"
          echo "test=${TEST_OK}" >> "$GITHUB_OUTPUT"
          echo "build=${BUILD_OK}" >> "$GITHUB_OUTPUT"
          echo "passed=${PASSED}" >> "$GITHUB_OUTPUT"

          echo "Quality gates: lint=${LINT_OK}, typecheck=${TYPECHECK_OK}, test=${TEST_OK}, build=${BUILD_OK}"

      - name: Review-fix quality gate failure
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-changes.outputs.has-changes == 'true' && steps.rf-quality.outputs.passed != 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          CYCLE: ${{ steps.rf-guard.outputs.cycle }}
          BRANCH: ${{ steps.rf-guard.outputs.branch }}
          LINT: ${{ steps.rf-quality.outputs.lint }}
          TYPECHECK: ${{ steps.rf-quality.outputs.typecheck }}
          TEST: ${{ steps.rf-quality.outputs.test }}
          BUILD: ${{ steps.rf-quality.outputs.build }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            const cycle = process.env.CYCLE;
            const branch = process.env.BRANCH;
            const lint = process.env.LINT === 'true' ? '‚úÖ' : '‚ùå';
            const typecheck = process.env.TYPECHECK === 'true' ? '‚úÖ' : '‚ùå';
            const test = process.env.TEST === 'true' ? '‚úÖ' : '‚ùå';
            const build = process.env.BUILD === 'true' ? '‚úÖ' : '‚ùå';

            // Ensure label exists
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'agent:needs-judgment',
                color: 'E4E669',
                description: 'Agent needs human judgment to proceed',
              });
            } catch {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['agent:needs-judgment'],
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                `<!-- review-fix-quality-failed: cycle-${cycle} -->`,
                `## ‚ùå Review-Fix Agent ‚Äî Quality Gates Failed (Cycle ${cycle}/3)`,
                '',
                'The review-fix agent made changes but quality gates did not pass.',
                'Changes were **not pushed**. A human should review and decide next steps.',
                '',
                '| Check | Result |',
                '|-------|--------|',
                `| Lint | ${lint} |`,
                `| Type Check | ${typecheck} |`,
                `| Tests | ${test} |`,
                `| Build | ${build} |`,
                '',
                `**Branch**: \`${branch}\``,
                `**Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                '',
                '---',
                '*ü§ñ [Issue Implementer Agent](https://github.com/codefactory) ‚Äî automated review-fix.*',
              ].join('\n'),
            });

      - name: Commit and push review-fix
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-changes.outputs.has-changes == 'true' && steps.rf-quality.outputs.passed == 'true'
        id: rf-push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.rf-guard.outputs.branch }}"
          CYCLE="${{ steps.rf-guard.outputs.cycle }}"
          PR_NUMBER="${{ inputs.pr_number }}"

          # Set remote URL with token for push auth
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"

          git add -A
          MODIFIED=$(git diff --cached --name-only | wc -l | tr -d ' ')

          git commit -m "$(cat <<COMMIT_EOF
          fix: address review feedback (cycle ${CYCLE})

          Review-fix for PR #${PR_NUMBER}, cycle ${CYCLE}/3.
          Files changed: ${MODIFIED}
          COMMIT_EOF
          )"

          git push
          NEW_SHA=$(git rev-parse HEAD)
          echo "new-sha=${NEW_SHA}" >> "$GITHUB_OUTPUT"
          echo "‚úî Pushed review-fix commit: ${NEW_SHA:0:12}"

      - name: Dispatch CI pipelines for re-review
        if: steps.mode.outputs.mode == 'review-fix' && steps.rf-push.outputs.new-sha
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ inputs.pr_number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Dispatching all CI pipelines for PR #${PR_NUMBER}..."
          gh workflow run ci.yml --repo "$REPO" --field pr_number="${PR_NUMBER}"
          gh workflow run risk-policy-gate.yml --repo "$REPO" --field pr_number="${PR_NUMBER}"
          gh workflow run code-review-agent.yml --repo "$REPO" --field pr_number="${PR_NUMBER}"
          echo "‚úî Dispatched CI + risk gate + review agent for re-review"

      - name: Review-fix failure handler
        if: failure() && steps.mode.outputs.mode == 'review-fix' && steps.rf-guard.outputs.should-fix == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          CYCLE: ${{ steps.rf-guard.outputs.cycle }}
          BRANCH: ${{ steps.rf-guard.outputs.branch }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            const cycle = process.env.CYCLE;
            const branch = process.env.BRANCH;

            // Add judgment label
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'agent:needs-judgment',
                color: 'E4E669',
                description: 'Agent needs human judgment to proceed',
              });
            } catch {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['agent:needs-judgment'],
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                `<!-- review-fix-failed: cycle-${cycle} -->`,
                `## ‚ùå Review-Fix Agent ‚Äî Failed (Cycle ${cycle}/3)`,
                '',
                'The review-fix agent encountered an error while addressing review feedback.',
                'A human should review the failure and decide next steps.',
                '',
                `**Branch**: \`${branch}\``,
                `**Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                '',
                '---',
                '*ü§ñ [Issue Implementer Agent](https://github.com/codefactory) ‚Äî automated review-fix.*',
              ].join('\n'),
            });

      # ======================================================================
      # ISSUE MODE ‚Äî implement a new issue (original behavior)
      # ======================================================================

      - name: Fetch issue JSON (workflow_dispatch)
        if: steps.mode.outputs.mode == 'issue' && github.event_name == 'workflow_dispatch'
        id: fetch-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ inputs.issue_number }}"
          # gh CLI uses 'author' not 'user' ‚Äî remap to match github.event.issue shape
          ISSUE_DATA=$(gh issue view "$ISSUE_NUM" --json number,title,body,labels,author \
            | jq '{number, title, body, labels, user: {login: .author.login, type: (if .author.is_bot then "Bot" else "User" end)}}')
          {
            echo "json<<ISSUE_EOF"
            echo "$ISSUE_DATA"
            echo "ISSUE_EOF"
          } >> "$GITHUB_OUTPUT"
          echo "Fetched issue #${ISSUE_NUM}"

      - name: Run implementer guard
        if: steps.mode.outputs.mode == 'issue'
        id: guard
        env:
          ISSUE_JSON: ${{ github.event_name == 'workflow_dispatch' && steps.fetch-issue.outputs.json || toJSON(github.event.issue) }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DECISION=$(npx tsx scripts/issue-implementer-guard.ts --evaluate)
          echo "decision<<GUARD_EOF" >> "$GITHUB_OUTPUT"
          echo "$DECISION" >> "$GITHUB_OUTPUT"
          echo "GUARD_EOF" >> "$GITHUB_OUTPUT"

          SHOULD=$(echo "$DECISION" | jq -r '.shouldImplement')
          BRANCH=$(echo "$DECISION" | jq -r '.branchName')
          REASON=$(echo "$DECISION" | jq -r '.reason')
          ISSUE_NUM=$(echo "$DECISION" | jq -r '.issueNumber')
          ISSUE_TITLE=$(echo "$DECISION" | jq -r '.issueTitle')
          echo "should-implement=${SHOULD}" >> "$GITHUB_OUTPUT"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "reason=${REASON}" >> "$GITHUB_OUTPUT"
          echo "issue-number=${ISSUE_NUM}" >> "$GITHUB_OUTPUT"
          echo "issue-title=${ISSUE_TITLE}" >> "$GITHUB_OUTPUT"

          echo "Guard: shouldImplement=${SHOULD}, branch=${BRANCH}, issue=#${ISSUE_NUM}"

      - name: Skip ‚Äî log reason
        if: steps.mode.outputs.mode == 'issue' && steps.guard.outputs.should-implement == 'false'
        run: |
          echo "::notice::Implementation skipped: ${{ steps.guard.outputs.reason }}"

      - name: Post starting comment
        if: steps.mode.outputs.mode == 'issue' && steps.guard.outputs.should-implement == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issueNumber = parseInt('${{ steps.guard.outputs.issue-number }}', 10);
            const branch = '${{ steps.guard.outputs.branch }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `<!-- issue-implementer-start: #${issueNumber} -->`,
                '## üöÄ Implementation Agent ‚Äî Starting',
                '',
                `Working on branch \`${branch}\`.`,
                '',
                `**Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                '',
                '---',
                '*ü§ñ [Issue Implementer Agent](https://github.com/codefactory) ‚Äî automated implementation.*',
              ].join('\n'),
            });

      - name: Create implementation branch
        if: steps.mode.outputs.mode == 'issue' && steps.guard.outputs.should-implement == 'true'
        id: branch
        run: |
          BRANCH="${{ steps.guard.outputs.branch }}"
          DEFAULT_BRANCH="${{ github.event.repository.default_branch || 'main' }}"

          git config user.name "implementer-bot[bot]"
          git config user.email "implementer-bot[bot]@users.noreply.github.com"

          # Delete remote branch if it exists (stale from a previous failed run)
          git push origin --delete "${BRANCH}" 2>/dev/null || true

          git checkout -b "${BRANCH}" "origin/${DEFAULT_BRANCH}"
          echo "created=true" >> "$GITHUB_OUTPUT"
          echo "‚úî Created branch: ${BRANCH}"

      - name: Run baseline validation
        if: steps.mode.outputs.mode == 'issue' && steps.guard.outputs.should-implement == 'true'
        id: baseline
        run: |
          echo "Running baseline validation..."

          LINT_OK="true"
          TYPECHECK_OK="true"
          TEST_OK="true"
          BUILD_OK="true"

          npm run lint 2>/dev/null || LINT_OK="false"
          npm run typecheck 2>/dev/null || TYPECHECK_OK="false"
          npm test 2>/dev/null || TEST_OK="false"
          npm run build 2>/dev/null || BUILD_OK="false"

          echo "lint=${LINT_OK}" >> "$GITHUB_OUTPUT"
          echo "typecheck=${TYPECHECK_OK}" >> "$GITHUB_OUTPUT"
          echo "test=${TEST_OK}" >> "$GITHUB_OUTPUT"
          echo "build=${BUILD_OK}" >> "$GITHUB_OUTPUT"

          echo "Baseline: lint=${LINT_OK}, typecheck=${TYPECHECK_OK}, test=${TEST_OK}, build=${BUILD_OK}"

      - name: Read implementer prompt
        if: steps.mode.outputs.mode == 'issue' && steps.guard.outputs.should-implement == 'true'
        id: prompt-file
        run: |
          if [[ -f ".codefactory/prompts/issue-implementer.md" ]]; then
            {
              echo "content<<PROMPT_EOF"
              cat .codefactory/prompts/issue-implementer.md
              echo "PROMPT_EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "content=Implement the feature or fix described in the issue." >> "$GITHUB_OUTPUT"
          fi

      - name: Extract plan comment
        if: steps.mode.outputs.mode == 'issue' && steps.guard.outputs.should-implement == 'true'
        id: plan-comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          ISSUE_NUM: ${{ steps.guard.outputs.issue-number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUM, 10);
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100,
            });

            const marker = `<!-- issue-planner: #${issueNumber} -->`;
            const planComment = comments.find((c) => c.body && c.body.includes(marker));

            if (planComment) {
              // Strip the marker and footer from the plan
              let plan = planComment.body || '';
              plan = plan.replace(marker, '').trim();
              core.setOutput('found', 'true');
              core.setOutput('plan', plan.slice(0, 8000));
              core.info(`Found plan comment (${plan.length} chars)`);
            } else {
              core.setOutput('found', 'false');
              core.setOutput('plan', '');
              core.info('No plan comment found ‚Äî proceeding without plan context.');
            }

      - name: Build implementation prompt
        if: steps.mode.outputs.mode == 'issue' && steps.guard.outputs.should-implement == 'true'
        id: build-prompt
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          IMPLEMENTER_TEMPLATE: ${{ steps.prompt-file.outputs.content }}
          BASELINE_LINT: ${{ steps.baseline.outputs.lint }}
          BASELINE_TYPECHECK: ${{ steps.baseline.outputs.typecheck }}
          BASELINE_TEST: ${{ steps.baseline.outputs.test }}
          BASELINE_BUILD: ${{ steps.baseline.outputs.build }}
          ISSUE_JSON: ${{ github.event_name == 'workflow_dispatch' && steps.fetch-issue.outputs.json || toJSON(github.event.issue) }}
          PLAN_FOUND: ${{ steps.plan-comment.outputs.found }}
          PLAN_CONTENT: ${{ steps.plan-comment.outputs.plan }}
        with:
          script: |
            const fs = require('fs');
            const issue = JSON.parse(process.env.ISSUE_JSON || '{}');
            const template = process.env.IMPLEMENTER_TEMPLATE || '';
            const planFound = process.env.PLAN_FOUND === 'true';
            const planContent = process.env.PLAN_CONTENT || '';

            let conventions = '';
            try { conventions = fs.readFileSync('CLAUDE.md', 'utf-8').slice(0, 6000); } catch {}

            let config = '';
            try { config = fs.readFileSync('harness.config.json', 'utf-8'); } catch {}

            const sections = [
              template,
              '',
              '## Issue to Implement',
              '',
              `**Number**: #${issue.number}`,
              `**Title**: ${issue.title}`,
              `**Author**: ${(issue.user || {}).login || 'unknown'}`,
              '',
              '### Body',
              '',
              issue.body || '*(empty body)*',
            ];

            if (planFound && planContent) {
              sections.push(
                '',
                '## Implementation Plan (from Planner Agent)',
                '',
                'The following plan was produced by the planning agent. Follow this plan closely:',
                '',
                planContent,
              );
            }

            sections.push(
              '',
              '## Project Conventions (from CLAUDE.md)',
              '',
              conventions || 'No CLAUDE.md found.',
              '',
              '## Harness Configuration',
              '',
              '```json',
              config || '{}',
              '```',
              '',
              '## Baseline Quality State',
              '',
              `| Check | Baseline |`,
              `|-------|----------|`,
              `| Lint | ${process.env.BASELINE_LINT === 'true' ? 'passing' : 'failing'} |`,
              `| Type Check | ${process.env.BASELINE_TYPECHECK === 'true' ? 'passing' : 'failing'} |`,
              `| Tests | ${process.env.BASELINE_TEST === 'true' ? 'passing' : 'failing'} |`,
              `| Build | ${process.env.BASELINE_BUILD === 'true' ? 'passing' : 'failing'} |`,
              '',
              'You must NOT introduce regressions ‚Äî if a check was passing in baseline, it must still pass after your changes.',
            );

            const prompt = sections.join('\n');
            core.setOutput('prompt', prompt);
            core.info(`Implementation prompt built (${prompt.length} chars)`);

      - name: Run Claude implementation
        if: steps.mode.outputs.mode == 'issue' && steps.guard.outputs.should-implement == 'true'
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.build-prompt.outputs.prompt }}
          claude_args: '--model claude-opus-4-6 --max-turns 100 --allowedTools "Edit,Write,Read,Glob,Grep,Bash"'
          allowed_bots: 'github-actions'

      - name: Check for file changes
        if: steps.mode.outputs.mode == 'issue' && steps.guard.outputs.should-implement == 'true'
        id: changes
        run: |
          CHANGED=$(git diff --name-only 2>/dev/null || echo "")
          UNTRACKED=$(git ls-files --others --exclude-standard 2>/dev/null || echo "")
          ALL_FILES=$(echo -e "${CHANGED}\n${UNTRACKED}" | sort -u | grep -v '^$' || echo "")

          if [[ -z "$ALL_FILES" ]]; then
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No files were modified by the implementation agent."
          else
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            COUNT=$(echo "$ALL_FILES" | wc -l)
            echo "count=${COUNT}" >> "$GITHUB_OUTPUT"
            {
              echo "files<<FILES_EOF"
              echo "$ALL_FILES"
              echo "FILES_EOF"
            } >> "$GITHUB_OUTPUT"
            echo "‚úî ${COUNT} file(s) changed"
          fi

      - name: Verify no protected files modified
        if: steps.mode.outputs.mode == 'issue' && steps.changes.outputs.has-changes == 'true'
        id: protected
        run: |
          MODIFIED=$(git diff --name-only)
          VIOLATIONS=""

          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            case "$file" in
              .github/workflows/*|harness.config.json|CLAUDE.md|package-lock.json|yarn.lock|pnpm-lock.yaml)
                VIOLATIONS="${VIOLATIONS}  - ${file}\n"
                git checkout -- "$file"
                echo "::warning::Reverted protected file: ${file}"
                ;;
            esac
          done <<< "$MODIFIED"

          if [[ -n "$VIOLATIONS" ]]; then
            echo "reverted=true" >> "$GITHUB_OUTPUT"
            echo "::warning::Reverted modifications to protected files."
          else
            echo "reverted=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run quality gates
        if: steps.mode.outputs.mode == 'issue' && steps.changes.outputs.has-changes == 'true'
        id: quality
        run: |
          echo "Running quality gates..."

          LINT_OK="true"
          TYPECHECK_OK="true"
          TEST_OK="true"
          BUILD_OK="true"

          npm run lint || LINT_OK="false"
          npm run typecheck || TYPECHECK_OK="false"
          npm test || TEST_OK="false"
          npm run build || BUILD_OK="false"

          echo "lint=${LINT_OK}" >> "$GITHUB_OUTPUT"
          echo "typecheck=${TYPECHECK_OK}" >> "$GITHUB_OUTPUT"
          echo "test=${TEST_OK}" >> "$GITHUB_OUTPUT"
          echo "build=${BUILD_OK}" >> "$GITHUB_OUTPUT"

          # Compare against baseline ‚Äî only fail on regressions
          REGRESSED="false"
          if [[ "${{ steps.baseline.outputs.lint }}" == "true" && "$LINT_OK" == "false" ]]; then
            REGRESSED="true"
            echo "::error::Regression: lint was passing, now failing."
          fi
          if [[ "${{ steps.baseline.outputs.typecheck }}" == "true" && "$TYPECHECK_OK" == "false" ]]; then
            REGRESSED="true"
            echo "::error::Regression: typecheck was passing, now failing."
          fi
          if [[ "${{ steps.baseline.outputs.test }}" == "true" && "$TEST_OK" == "false" ]]; then
            REGRESSED="true"
            echo "::error::Regression: tests were passing, now failing."
          fi
          if [[ "${{ steps.baseline.outputs.build }}" == "true" && "$BUILD_OK" == "false" ]]; then
            REGRESSED="true"
            echo "::error::Regression: build was passing, now failing."
          fi

          echo "regressed=${REGRESSED}" >> "$GITHUB_OUTPUT"
          echo "Quality gates: lint=${LINT_OK}, typecheck=${TYPECHECK_OK}, test=${TEST_OK}, build=${BUILD_OK}, regressed=${REGRESSED}"

      - name: Commit, push, and create PR
        if: steps.mode.outputs.mode == 'issue' && steps.changes.outputs.has-changes == 'true' && steps.quality.outputs.regressed == 'false'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.guard.outputs.branch }}"
          ISSUE_NUMBER="${{ steps.guard.outputs.issue-number }}"
          ISSUE_TITLE="${{ steps.guard.outputs.issue-title }}"
          DEFAULT_BRANCH="${{ github.event.repository.default_branch || 'main' }}"

          # Set remote URL with token for push auth
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"

          # Stage all changes (new + modified)
          git add -A

          MODIFIED=$(git diff --cached --name-only | wc -l | tr -d ' ')

          git commit -m "$(cat <<COMMIT_EOF
          feat: implement #${ISSUE_NUMBER} ‚Äî ${ISSUE_TITLE}

          Automated implementation for issue #${ISSUE_NUMBER}.
          Files changed: ${MODIFIED}

          Closes #${ISSUE_NUMBER}
          COMMIT_EOF
          )"

          git push -u origin "${BRANCH}"

          # Ensure agent-pr label exists
          gh label create "agent-pr" --color "BFD4F2" --description "PR created by implementation agent" 2>/dev/null || true

          # Create PR
          PR_URL=$(gh pr create \
            --base "${DEFAULT_BRANCH}" \
            --head "${BRANCH}" \
            --title "feat: ${ISSUE_TITLE}" \
            --label "agent-pr" \
            --body "$(cat <<PR_EOF
          ## Summary

          Automated implementation for #${ISSUE_NUMBER}.

          <!-- issue-implementer: #${ISSUE_NUMBER} -->

          ## Quality Gates

          | Check | Status |
          |-------|--------|
          | Lint | ${{ steps.quality.outputs.lint == 'true' && '‚úÖ' || '‚ö†Ô∏è (baseline was also failing)' }} |
          | Type Check | ${{ steps.quality.outputs.typecheck == 'true' && '‚úÖ' || '‚ö†Ô∏è (baseline was also failing)' }} |
          | Tests | ${{ steps.quality.outputs.test == 'true' && '‚úÖ' || '‚ö†Ô∏è (baseline was also failing)' }} |
          | Build | ${{ steps.quality.outputs.build == 'true' && '‚úÖ' || '‚ö†Ô∏è (baseline was also failing)' }} |

          Closes #${ISSUE_NUMBER}

          ---
          *ü§ñ [Issue Implementer Agent](https://github.com/codefactory) ‚Äî automated implementation.*
          PR_EOF
          )")

          echo "url=${PR_URL}" >> "$GITHUB_OUTPUT"
          PR_NUM=$(echo "$PR_URL" | grep -oP '\d+$')
          echo "number=${PR_NUM}" >> "$GITHUB_OUTPUT"
          echo "‚úî Created PR: ${PR_URL}"

      - name: Post PR-created comment on issue
        if: steps.mode.outputs.mode == 'issue' && steps.pr.outputs.url
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PR_URL: ${{ steps.pr.outputs.url }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const issueNumber = parseInt('${{ steps.guard.outputs.issue-number }}', 10);
            const prUrl = process.env.PR_URL;
            const prNumber = process.env.PR_NUMBER;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `<!-- issue-implementer: #${issueNumber} -->`,
                '## ‚úÖ Implementation Agent ‚Äî PR Created',
                '',
                `Pull request ${prUrl} has been created to address this issue.`,
                '',
                '---',
                '*ü§ñ [Issue Implementer Agent](https://github.com/codefactory) ‚Äî automated implementation.*',
              ].join('\n'),
            });

      - name: Dispatch CI pipelines for new PR
        if: steps.mode.outputs.mode == 'issue' && steps.pr.outputs.number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUM: ${{ steps.pr.outputs.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Dispatching all CI pipelines for PR #${PR_NUM}..."
          gh workflow run ci.yml --repo "$REPO" --field pr_number="${PR_NUM}"
          gh workflow run risk-policy-gate.yml --repo "$REPO" --field pr_number="${PR_NUM}"
          gh workflow run code-review-agent.yml --repo "$REPO" --field pr_number="${PR_NUM}"
          echo "‚úî Dispatched CI + risk gate + review agent for PR #${PR_NUM}"

      - name: Failure handler
        if: failure() && steps.mode.outputs.mode == 'issue' && steps.guard.outputs.should-implement == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issueNumber = parseInt('${{ steps.guard.outputs.issue-number }}', 10);

            // Add judgment label
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'agent:needs-judgment',
                color: 'E4E669',
                description: 'Agent needs human judgment to proceed',
              });
            } catch {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['agent:needs-judgment'],
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `<!-- issue-implementer-failed: #${issueNumber} -->`,
                '## ‚ùå Implementation Agent ‚Äî Failed',
                '',
                'The implementation agent encountered an error while working on this issue.',
                'A human should review the failure and decide next steps.',
                '',
                `**Branch**: \`${{ steps.guard.outputs.branch }}\``,
                `**Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                '',
                '---',
                '*ü§ñ [Issue Implementer Agent](https://github.com/codefactory) ‚Äî automated implementation.*',
              ].join('\n'),
            });
