name: Structural Tests

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  structural-tests:
    name: Architectural Boundary Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate architectural boundaries
        run: bash scripts/structural-tests.sh

      - name: Validate import-type discipline
        run: |
          echo "Checking for value imports of type-only symbols..."
          violations=0
          while IFS= read -r -d '' file; do
            # Flag imports from known type-only files that don't use 'import type'
            if grep -Pn "^import\s+\{[^}]+\}\s+from\s+['\"].*types['\"]" "$file" | grep -v "import type" > /dev/null 2>&1; then
              echo "::warning file=${file#./}::Possible missing 'import type' for types-only module"
            fi
          done < <(find src -name '*.ts' -type f -print0)
          echo "✔ Import-type discipline check complete"

      - name: Verify no circular imports
        run: |
          echo "Scanning for obvious circular import patterns..."
          # Check that utils/ never imports from any sibling module
          if grep -rE "from\s+['\"]\.\.\/(commands|core|harnesses|prompts|providers|ui)\/" src/utils/ 2>/dev/null; then
            echo "::error::utils/ must not import from sibling modules"
            exit 1
          fi
          # Check that core/ only imports from utils/
          if grep -rE "from\s+['\"]\.\.\/(commands|harnesses|prompts|providers|ui)\/" src/core/ 2>/dev/null; then
            echo "::error::core/ must only import from utils/"
            exit 1
          fi
          # Check that ui/ only imports from utils/
          if grep -rE "from\s+['\"]\.\.\/(commands|core|harnesses|prompts|providers)\/" src/ui/ 2>/dev/null; then
            echo "::error::ui/ must only import from utils/"
            exit 1
          fi
          echo "✔ No circular import patterns detected"
