name: Review Agent Rerun Writer

on:
  pull_request:
    types: [synchronize]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: review-rerun-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  rerun-writer:
    name: SHA-Deduped Rerun Request
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Post rerun comment (SHA-deduped)
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const headSha = context.payload.pull_request.head.sha;
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const marker = '<!-- review-agent-auto-rerun -->';
            const trigger = `sha:${headSha}`;

            core.info(`Checking for existing rerun request for SHA ${headSha.slice(0, 12)}...`);

            // Fetch existing PR comments (paginate to be safe)
            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number: prNumber, per_page: 100 },
            );

            // Check if we already requested a rerun for this exact SHA
            const alreadyRequested = comments.some(
              (c) => c.body?.includes(marker) && c.body?.includes(trigger),
            );

            if (alreadyRequested) {
              core.info(`Rerun already requested for SHA ${headSha.slice(0, 12)} â€” skipping.`);
              return;
            }

            // Post exactly ONE rerun comment for this SHA
            const body = [
              marker,
              `ðŸ”„ New commits pushed â€” requesting re-review.`,
              '',
              `**Commit**: \`${headSha.slice(0, 12)}\``,
              trigger,
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body,
            });

            core.info(`Posted rerun request for SHA ${headSha.slice(0, 12)}.`);
